<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Losses Tracker</title>
  <style>
    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:#f9fafb;
      padding:16px;
    }
    header {
      background:#fff;
      border-radius:12px;
      padding:16px 20px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
      margin-bottom:16px;
    }
    .row {
      display:flex;
      flex-wrap:wrap;
      gap:8px 16px;
      font-size:14px;
      color:#333;
      line-height:1.4;
    }
    .row > div { min-width:140px; }
    .badge {
      display:inline-block;
      font-size:12px;
      padding:4px 8px;
      background:#eef2ff;
      border-radius:6px;
      font-weight:500;
    }
    .danger {
      color:#c00;
      font-size:13px;
      font-weight:500;
      margin-top:8px;
    }
    button {
      font-size:14px;
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #bbb;
      background:#fff;
      cursor:pointer;
    }
    button.primary {
      background:#222;
      color:#fff;
      border:none;
      font-weight:600;
    }
    button.primary:active { transform:scale(.98); }
    section.card {
      background:#fff;
      border-radius:12px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
      padding:16px 20px;
      margin-bottom:16px;
    }
    h2.card-title {
      margin:0 0 12px 0;
      font-size:16px;
      font-weight:600;
    }
    label {
      display:block;
      font-size:13px;
      font-weight:600;
      color:#222;
      margin-top:12px;
    }
    input, select, textarea {
      width:100%;
      margin-top:6px;
      box-sizing:border-box;
      border:1px solid #ccc;
      border-radius:8px;
      padding:8px 10px;
      font-size:14px;
      background:#fff;
    }
    .flex-row {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .flex-col {
      flex:1;
      min-width:120px;
    }
    .smallnote {
      font-size:11px;
      color:#666;
      line-height:1.4;
      margin-top:4px;
    }
    .readonly-box {
      background:#f3f4f6;
    }
    .table-list > div {
      border-bottom:1px solid #eee;
      padding:8px 0;
      font-size:13px;
      line-height:1.4;
    }
    .table-list .meta {
      color:#666;
      font-size:12px;
    }
  </style>
</head>
<body>

<header>
  <div class="row">
    <div><strong>User:</strong> <span id="hdrUser" class="badge">-</span></div>
    <div><strong>Role:</strong> <span id="hdrRole" class="badge">-</span></div>
    <div><strong>Email:</strong> <span id="hdrEmail" class="badge">-</span></div>
  </div>

  <div class="row">
    <div><button id="btnSwitchUser">Ganti User</button></div>
    <div><button id="btnLogout" class="danger-btn">Logout</button></div>
  </div>

  <div id="accessWarn" class="danger" style="display:none;">
    Role Anda tidak cukup untuk fitur tertentu.
  </div>
</header>

<section class="card">
  <h2 class="card-title">Input Loss Event</h2>

  <div class="flex-row">
    <div class="flex-col">
      <label>Line</label>
      <input id="inpLine" placeholder="Line 1 / Area XYZ"/>
    </div>

    <div class="flex-col">
      <label>Mesin</label>
      <select id="inpMesin"></select>
      <div class="smallnote">List dari tabel mesin</div>
    </div>

    <div class="flex-col">
      <label>Shift</label>
      <select id="inpShift">
        <option value="A">Shift A</option>
        <option value="B">Shift B</option>
        <option value="C">Shift C</option>
      </select>
    </div>
  </div>

  <div class="flex-row">
    <div class="flex-col">
      <label>Waktu Start</label>
      <input type="datetime-local" id="inpStart"/>
    </div>
    <div class="flex-col">
      <label>Waktu Finish</label>
      <input type="datetime-local" id="inpFinish"/>
    </div>
    <div class="flex-col">
      <label>Durasi Hilang (menit)</label>
      <input type="number" id="inpDurasi" min="0" step="1" placeholder="0" />
      <div class="smallnote">Otomatis dihitung dari Start-Finish, tapi masih bisa di-edit manual kalau perlu koreksi.</div>
    </div>
  </div>

  <div class="flex-row">
    <div class="flex-col">
      <label>Kategori Loss</label>
      <select id="inpCategory">
        <option value="No Material">No Material</option>
        <option value="Breakdown Mesin">Breakdown Mesin</option>
        <option value="Changeover / Setup">Changeover / Setup</option>
        <option value="Quality / Rework">Quality / Rework</option>
        <option value="Meeting / Briefing">Meeting / Briefing</option>
        <option value="Lainnya">Lainnya</option>
      </select>
    </div>

    <div class="flex-col">
      <label>Detail / Subcause</label>
      <textarea id="inpIssue" rows="2" placeholder="contoh: Tidak ada outer panel tipe ABC"></textarea>
    </div>
  </div>

  <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;">
    <button class="primary" id="btnSubmitLoss">Submit Loss</button>
  </div>

  <div id="submitMsg" class="danger" style="display:none;"></div>
</section>

<section class="card">
  <h2 class="card-title">Data Terbaru</h2>
  <div id="lossList" class="table-list">Loading...</div>
</section>

<script>
const BACKEND_URL = "PASTE_YOUR_WEB_APP_URL_HERE";

const lossesEmail    = localStorage.getItem("losses_email");
const lossesUsername = localStorage.getItem("losses_username");
const lossesRole     = localStorage.getItem("losses_role");

if (!lossesEmail || !lossesUsername || !lossesRole) {
  window.location.href = "index.html";
}

document.getElementById("hdrUser").textContent  = lossesUsername;
document.getElementById("hdrRole").textContent  = lossesRole;
document.getElementById("hdrEmail").textContent = lossesEmail;

function roleAtLeast(need){
  const order=["guest","operator","supervisor","admin"];
  return order.indexOf(lossesRole)>=order.indexOf(need);
}

document.getElementById("btnLogout").addEventListener("click", () => {
  localStorage.removeItem("losses_email");
  localStorage.removeItem("losses_username");
  localStorage.removeItem("losses_role");
  window.location.href="index.html";
});

document.getElementById("btnSwitchUser").addEventListener("click", () => {
  window.location.href="index.html";
});

// ===== Mesin dropdown =====
async function loadMesinList(){
  try{
    const res=await fetch("machines.json");
    const data=await res.json(); // ex: [ {"code":"MC-01","name":"Press HF"}, ... ]
    const sel=document.getElementById("inpMesin");
    sel.innerHTML="";
    data.forEach(m=>{
      const opt=document.createElement("option");
      opt.value = m.name || m.code || "";
      opt.textContent = m.name ? (m.code? m.code+" - "+m.name : m.name) : m.code;
      sel.appendChild(opt);
    });
  }catch(err){
    const sel=document.getElementById("inpMesin");
    sel.innerHTML="<option value=''>[Error load mesin]</option>";
  }
}

// ===== Durasi auto-calc =====
function recalcDuration(){
  const startVal=document.getElementById("inpStart").value;
  const finishVal=document.getElementById("inpFinish").value;
  if(!startVal || !finishVal) return;
  const startTs=new Date(startVal).getTime();
  const finishTs=new Date(finishVal).getTime();
  if(isNaN(startTs)||isNaN(finishTs)) return;
  const diffMs=finishTs-startTs;
  if(diffMs<0) return;
  const mins=Math.round(diffMs/60000);
  const durEl=document.getElementById("inpDurasi");
  if(durEl.value==="" || Number(durEl.value)===0){
    durEl.value=mins;
  }
}
document.getElementById("inpStart").addEventListener("change",recalcDuration);
document.getElementById("inpFinish").addEventListener("change",recalcDuration);

// ===== Submit Loss =====
async function submitLoss(){
  if(!roleAtLeast("operator")) {
    showSubmitMsg("Role Anda tidak diizinkan membuat data (butuh operator).");
    return;
  }

  const lineVal   = document.getElementById("inpLine").value.trim();
  const mesinVal  = document.getElementById("inpMesin").value.trim();
  const shiftVal  = document.getElementById("inpShift").value;
  const startVal  = document.getElementById("inpStart").value;
  const finishVal = document.getElementById("inpFinish").value;
  const durasiVal = document.getElementById("inpDurasi").value.trim();
  const catVal    = document.getElementById("inpCategory").value;
  const issueVal  = document.getElementById("inpIssue").value.trim();

  if(!lineVal || !mesinVal || !shiftVal || !durasiVal || !catVal || !startVal || !finishVal){
    showSubmitMsg("Field wajib belum lengkap.");
    return;
  }

  const payloadObj = {
    "Line": lineVal,
    "Mesin": mesinVal,
    "Shift": shiftVal,
    "WAKTU START": startVal,
    "WAKTU FINISH": finishVal,
    "Durasi Hilang": durasiVal,
    "Kategori": catVal,
    "Issue": issueVal,
    "Pelapor": lossesUsername
  };

  try{
    const res=await fetch(BACKEND_URL+"?action=create_losses", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        email: lossesEmail,
        username: lossesUsername,
        role: lossesRole,
        data: payloadObj
      })
    });
    const json=await res.json();
    if(!json.ok){
      showSubmitMsg("Gagal submit: "+(json.error||"unknown"));
      return;
    }
    showSubmitMsg("Berhasil disimpan ("+(json.inserted||1)+" row).",true);
    await loadList();
    document.getElementById("inpDurasi").value="";
    document.getElementById("inpIssue").value="";
  }catch(err){
    showSubmitMsg("Error submit: "+err);
  }
}
document.getElementById("btnSubmitLoss").addEventListener("click",submitLoss);

function showSubmitMsg(msg,ok=false){
  const box=document.getElementById("submitMsg");
  box.style.display="block";
  box.style.color= ok ? "#0a0" : "#c00";
  box.textContent=msg;
  setTimeout(()=>{ box.style.display="none"; },4000);
}

// ===== Load list =====
async function loadList(){
  if(!roleAtLeast("operator")) {
    document.getElementById("accessWarn").style.display="block";
    document.getElementById("lossList").textContent="Akses dibatasi.";
    return;
  }
  try{
    const res=await fetch(
      BACKEND_URL+"?action=list_losses&page=1&pageSize=20"
      +"&email="+encodeURIComponent(lossesEmail)
      +"&username="+encodeURIComponent(lossesUsername)
      +"&role="+encodeURIComponent(lossesRole)
    );
    const json=await res.json();
    if(!json.ok){
      document.getElementById("lossList").textContent="Gagal load data: "+(json.error||"");
      return;
    }
    if(!json.items || !json.items.length){
      document.getElementById("lossList").textContent="Belum ada data.";
      return;
    }
    const htmlRows=json.items.map(it=>{
      const line  = it["Line"]||"-";
      const mesin = it["Mesin"]||"-";
      const shft  = it["Shift"]||"-";
      const cat   = it["Kategori"]||"-";
      const mins  = it["Durasi Hilang"]||"-";
      const who   = it["Pelapor"]||"-";
      const when  = it["lastUpdated"]||"";
      return `
        <div>
          <div><strong>${line}</strong> | ${mesin} | Shift ${shft} | ${cat}</div>
          <div>Durasi: ${mins} menit | Pelapor: ${who}</div>
          <div class="meta">Update: ${when}</div>
        </div>
      `;
    }).join("");
    document.getElementById("lossList").innerHTML=htmlRows;
  }catch(err){
    document.getElementById("lossList").textContent="Error load list: "+err;
  }
}

// init
loadMesinList();
loadList();
</script>
</body>
</html>
